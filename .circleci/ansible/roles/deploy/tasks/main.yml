---
  - name: "Update local repo"
    become: true
    apt:
      update_cache: yes
      cache_valid_time: 86400
        
  - name: "remove unneeded deps"
    become: true
    apt:
      autoremove: yes

 - name: "Package upgrade"
    become: true
    apt:
      upgrade: "yes"

  - name: "install nodejs and npm."
    become: true
    apt:
      name: ["nodejs", "npm"]
      state: latest
      update_cache: yes

  - name: "install n"
    become: true
    npm:
      name: n
      global: yes
      production: yes

  - name: "install nodejs - 13.8.0"
    become: true
    shell: n 13.8.0

  - name: "install pm2"
    become: true
    npm:
      name: pm2
      global: yes
      production: yes
      state: present 

  - name: Create Backend App Directory
    file:
      path: ~/backend-app
      state: directory
      
  - name: Unarchive files
    become: true
      src: artifact.tar.gz
      dest: ~/backend-app
      
  # - name: "Executing Node app with PM2"
  #   shell: |
  #     cd ~/backend-app/dist
      
  #     cd ../
  #     npm install --force
  #     npm run build
      
  #     sudo npm install forever -g
  #     sudo npm install ts-node
  #     forever start -c "ts-node -r tsconfig-paths/register -r dotenv/config src/main.ts" ./

  - name: "Start application"
    become: true
    shell: |
      npm install
      pm2 stop default
      pm2 start npm -- start
    
    